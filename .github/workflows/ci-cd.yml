name: CI/CD Windows

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: self-hosted

    steps:
      # 1. Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯
      - name: Checkout
        uses: actions/checkout@v3

      # 2. ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
      - name: Stop Old Services
        shell: cmd
        run: |
          taskkill /F /IM node.exe >nul 2>&1
          echo No node processes running

          taskkill /F /IM caddy.exe >nul 2>&1
          echo No caddy processes running

          timeout /t 2 >nul

      # 3. Ø¯Ø§Ù†Ù„ÙˆØ¯ Caddy
      - name: Download Caddy
        shell: cmd
        run: |
          if not exist "caddy\caddy.exe" (
            echo Downloading Caddy...
            curl -L https://github.com/caddyserver/caddy/releases/download/v2.7.6/caddy_2.7.6_windows_amd64.zip -o caddy.zip
            tar -xf caddy.zip -C caddy_temp
            mkdir caddy 2>nul
            move caddy_temp\caddy.exe caddy\ 2>nul
            rmdir /s /q caddy_temp 2>nul
            del caddy.zip 2>nul
            echo Caddy downloaded
          ) else (
            echo Caddy already exists
          )

      # 4. Ù†ØµØ¨ Ùˆ Ø§Ø¬Ø±Ø§ÛŒ Backend
      - name: Setup Backend
        shell: cmd
        run: |
          cd backend
          call npm install

          echo Starting backend...
          start /B node server.js

          timeout /t 5 >nul

          echo Testing backend...
          curl http://localhost:3001/api/hello || echo Backend might be starting...

      # 5. Ø³Ø§Ø®Øª Frontend
      - name: Build Frontend
        shell: cmd
        run: |
          cd frontend
          call npm install
          call npm run build

          if exist "dist\index.html" (
            echo Frontend built successfully
          ) else (
            echo ERROR: Frontend build failed!
            exit 1
          )

      # 6. Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Frontend
      - name: Copy Frontend Files
        shell: cmd
        run: |
          mkdir caddy\www 2>nul
          xcopy /E /Y frontend\dist\* caddy\www\ >nul
          echo Frontend files copied

      # 7. Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Caddyfile
      - name: Create Caddyfile
        shell: cmd
        run: |
          echo :8080 { > caddy\Caddyfile
          echo   root * ./www >> caddy\Caddyfile
          echo   file_server >> caddy\Caddyfile
          echo   try_files {path} /index.html >> caddy\Caddyfile
          echo. >> caddy\Caddyfile
          echo   handle /api/* { >> caddy\Caddyfile
          echo     reverse_proxy localhost:3001 >> caddy\Caddyfile
          echo   } >> caddy\Caddyfile
          echo } >> caddy\Caddyfile
          echo Caddyfile created

      # 8. Ø§Ø¬Ø±Ø§ÛŒ Caddy
      - name: Run Caddy
        shell: cmd
        run: |
          cd caddy
          echo Starting Caddy on port 8080...
          start /B caddy.exe run --config Caddyfile

          timeout /t 5 >nul

          echo Testing Caddy...
          curl http://localhost:8080 || echo Caddy might be starting...

      # 9. Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ
      - name: Final Status
        shell: cmd
        run: |
          echo ====================================
          echo ðŸš€ DEPLOYMENT COMPLETE
          echo ====================================
          echo.
          echo ðŸ” Checking services...
          echo.

          echo 1. Listening ports:
          netstat -ano | findstr ":8080 :3001" || echo Ports not found yet...
          echo.

          echo 2. Running processes:
          tasklist | findstr "node.exe caddy.exe" || echo Processes starting...
          echo.

          echo 3. Frontend files:
          dir caddy\www 2>nul || echo www folder not found
          echo.

          echo 4. Access URLs:
          echo    Frontend: http://localhost:8080
          echo    Backend API: http://localhost:3001/api/hello
          echo.
          echo 5. Manual test commands:
          echo    curl http://localhost:8080
          echo    curl http://localhost:3001/api/hello
          echo.
          echo ====================================
