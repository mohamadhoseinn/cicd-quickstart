name: CI/CD with Caddy (cached)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Cache Caddy
        uses: actions/cache@v3
        with:
          path: caddy/caddy.exe
          key: caddy-exe

      - name: Ensure Caddy exists
        run: |
          if (-Not (Test-Path "caddy\caddy.exe")) {
            Write-Host "Caddy not found in cache, downloading..."
            Invoke-WebRequest "https://github.com/caddyserver/caddy/releases/download/v2.7.6/caddy_2.7.6_windows_amd64.zip" -OutFile caddy.zip
            Expand-Archive caddy.zip -DestinationPath caddy_tmp
            mkdir caddy -Force
            Move-Item caddy_tmp/caddy.exe caddy\
            Remove-Item caddy.zip, caddy_tmp -Recurse -Force
          } else {
            Write-Host "Caddy found in cache, skipping download."
          }

      # توقف سرویس‌های قبلی
      - name: Stop existing services
        run: |
          Stop-Process -Name "node" -ErrorAction SilentlyContinue
          Stop-Process -Name "caddy" -ErrorAction SilentlyContinue
          timeout /t 2 /nobreak

      # شروع backend
      - name: Install and start backend
        run: |
          cd backend
          npm install
          # اجرای بک‌اند در پس‌زمینه
          Start-Process "node" -ArgumentList "server.js" -WorkingDirectory "$PWD"
          timeout /t 5 /nobreak

      # Build فرانت‌اند
      - name: Build frontend
        run: |
          cd frontend
          npm install
          npm run build

          # بررسی خروجی build
          if (Test-Path "dist/index.html") {
            Write-Host "✅ Frontend build successful"
          } else {
            Write-Error "❌ Frontend build failed"
            exit 1
          }

      # کپی فایل‌های build شده
      - name: Copy build to Caddy folder
        run: |
          # ایجاد پوشه‌های لازم
          mkdir -Force caddy\frontend
          # کپی فایل‌های build
          Copy-Item -Path frontend\dist\* -Destination caddy\frontend -Recurse -Force

          # کپی Caddyfile
          Copy-Item -Path caddy\Caddyfile -Destination caddy\frontend\Caddyfile -Force

      # اجرای Caddy با پورت قابل دسترسی
      - name: Start Caddy server
        run: |
          cd caddy
          # اجرای Caddy در پیش‌زمینه (نه پس‌زمینه)
          Write-Host "Starting Caddy on port 8080..."
          $caddyProcess = Start-Process ".\caddy.exe" `
            -ArgumentList "run --config .\Caddyfile --adapter caddyfile" `
            -NoNewWindow `
            -PassThru

          # ذخیره Process ID برای مدیریت بعدی
          $caddyProcess.Id | Out-File "caddy_pid.txt"

          # منتظر بمان تا Caddy کامل بالا بیاید
          timeout /t 10 /nobreak

          # تست اتصال
          $response = Invoke-WebRequest "http://localhost:8080" -Method GET -ErrorAction SilentlyContinue
          if ($response.StatusCode -eq 200) {
            Write-Host "✅ Caddy is running on port 8080"
          } else {
            Write-Host "⚠️  Could not verify Caddy. Checking processes..."
            Get-Process caddy, node
          }

      # نمایش اطلاعات برای دیباگ
      - name: Debug info
        run: |
          Write-Host "=== Network Connections ==="
          netstat -ano | findstr :8080
          netstat -ano | findstr :3001

          Write-Host "=== Running Processes ==="
          Get-Process caddy, node | Format-Table Id, Name, MainWindowTitle

          Write-Host "=== Directory Structure ==="
          Get-ChildItem caddy\frontend -Recurse | Select-Object Name, Length | Format-Table
