name: CI/CD Windows PowerShell

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: self-hosted

    steps:
      # 1. Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯
      - name: Checkout
        uses: actions/checkout@v3

      # 2. ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
      - name: Stop Old Services
        shell: pwsh
        run: |
          Write-Host "Stopping old services..."
          Get-Process -Name "node" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
          Get-Process -Name "caddy" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          Write-Host "Services stopped"

      # 3. Ø¯Ø§Ù†Ù„ÙˆØ¯ Caddy Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
      - name: Setup Caddy
        shell: pwsh
        run: |
          $caddyPath = "caddy\caddy.exe"

          if (-not (Test-Path $caddyPath)) {
              Write-Host "Downloading Caddy..."
              $downloadUrl = "https://github.com/caddyserver/caddy/releases/download/v2.7.6/caddy_2.7.6_windows_amd64.zip"
              $zipFile = "caddy.zip"
              
              Invoke-WebRequest -Uri $downloadUrl -OutFile $zipFile
              Expand-Archive -Path $zipFile -DestinationPath "caddy_temp" -Force
              
              New-Item -ItemType Directory -Path "caddy" -Force | Out-Null
              Move-Item -Path "caddy_temp\caddy.exe" -Destination "caddy\" -Force
              
              Remove-Item -Path $zipFile -Force
              Remove-Item -Path "caddy_temp" -Recurse -Force
              
              Write-Host "Caddy downloaded successfully"
          } else {
              Write-Host "Caddy already exists"
          }

      # 4. Ø§Ø¬Ø±Ø§ÛŒ Backend
      - name: Start Backend
        shell: pwsh
        run: |
          Set-Location "backend"

          Write-Host "Installing backend dependencies..."
          npm install

          Write-Host "Starting backend server..."
          $backendJob = Start-Job -ScriptBlock {
              Set-Location "backend"
              node server.js
          }

          Write-Host "Backend starting (PID: $($backendJob.Id))"
          Start-Sleep -Seconds 5

          # ØªØ³Øª Backend
          try {
              $response = Invoke-RestMethod -Uri "http://localhost:3001/api/hello" -TimeoutSec 10
              Write-Host "âœ… Backend is running: $($response.message)"
          } catch {
              Write-Host "âš ï¸ Backend test failed, but continuing..."
          }

      # 5. Ø³Ø§Ø®Øª Frontend
      - name: Build Frontend
        shell: pwsh
        run: |
          Set-Location "frontend"

          Write-Host "Installing frontend dependencies..."
          npm install

          Write-Host "Building frontend..."
          npm run build

          # Ø¨Ø±Ø±Ø³ÛŒ Build
          if (Test-Path "dist\index.html") {
              Write-Host "âœ… Frontend build successful"
              
              # Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ù‡ Ù¾ÙˆØ´Ù‡ Caddy
              $wwwPath = "..\caddy\www"
              New-Item -ItemType Directory -Path $wwwPath -Force | Out-Null
              Copy-Item -Path "dist\*" -Destination $wwwPath -Recurse -Force
              Write-Host "Frontend files copied to caddy\www"
          } else {
              Write-Host "âŒ Frontend build failed - index.html not found"
              exit 1
          }

      # 6. Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Caddyfile
      - name: Create Caddyfile
        shell: pwsh
        run: |
          $caddyConfig = @"
          :8080 {
              root * ./www
              file_server
              try_files {path} /index.html
              
              handle /api/* {
                  reverse_proxy localhost:3001
              }
          }
          "@

          $caddyfilePath = "caddy\Caddyfile"
          $caddyConfig | Out-File -FilePath $caddyfilePath -Encoding UTF8
          Write-Host "Caddyfile created at $caddyfilePath"

      # 7. Ø§Ø¬Ø±Ø§ÛŒ Caddy
      - name: Run Caddy
        shell: pwsh
        run: |
          Set-Location "caddy"

          Write-Host "Starting Caddy server on port 8080..."

          # Ø§Ø¬Ø±Ø§ÛŒ Caddy
          $caddyProcess = Start-Process -FilePath ".\caddy.exe" `
            -ArgumentList "run --config Caddyfile" `
            -PassThru `
            -NoNewWindow

          Write-Host "Caddy started (PID: $($caddyProcess.Id))"
          Start-Sleep -Seconds 5

          # ØªØ³Øª Caddy
          try {
              $response = Invoke-WebRequest -Uri "http://localhost:8080" -UseBasicParsing
              Write-Host "âœ… Caddy is running (HTTP $($response.StatusCode))"
          } catch {
              Write-Host "âš ï¸ Caddy test failed, checking status..."
          }

      # 8. Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ
      - name: Show Final Status
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "ğŸš€ DEPLOYMENT COMPLETE"
          Write-Host "=========================================="
          Write-Host ""

          # 1. Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§
          Write-Host "1. NETWORK PORTS:"
          Write-Host "-----------------"
          $ports = @(8080, 3001)
          foreach ($port in $ports) {
              $result = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue
              if ($result) {
                  Write-Host "Port $port : LISTENING âœ…"
              } else {
                  Write-Host "Port $port : NOT LISTENING âŒ"
              }
          }

          # 2. Ø¨Ø±Ø±Ø³ÛŒ ProcessÙ‡Ø§
          Write-Host ""
          Write-Host "2. RUNNING PROCESSES:"
          Write-Host "---------------------"
          $processes = Get-Process -Name "node", "caddy" -ErrorAction SilentlyContinue
          if ($processes) {
              $processes | Format-Table Id, Name, @{Name="WorkingSet(MB)";Expression={[math]::Round($_.WorkingSet/1MB,2)}} -AutoSize
          } else {
              Write-Host "No processes found"
          }

          # 3. Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
          Write-Host ""
          Write-Host "3. FRONTEND FILES:"
          Write-Host "------------------"
          $wwwPath = "caddy\www"
          if (Test-Path $wwwPath) {
              Get-ChildItem -Path $wwwPath | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
          } else {
              Write-Host "Frontend files not found"
          }

          # 4. Ø¯Ø³ØªÙˆØ±Ø§Øª ØªØ³Øª
          Write-Host ""
          Write-Host "4. TEST COMMANDS:"
          Write-Host "-----------------"
          Write-Host "Frontend:  Invoke-WebRequest http://localhost:8080"
          Write-Host "Backend:   Invoke-RestMethod http://localhost:3001/api/hello"
          Write-Host ""
          Write-Host "5. MANUAL CHECK:"
          Write-Host "----------------"
          Write-Host "1. Open browser to: http://localhost:8080"
          Write-Host "2. Test API: http://localhost:3001/api/hello"
          Write-Host ""
          Write-Host "=========================================="

      # 9. ØªØ³Øª Ø§ØªØµØ§Ù„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
      - name: Quick Test
        shell: pwsh
        run: |
          Write-Host "Running quick tests..."

          # ØªØ³Øª Backend
          Write-Host "Testing Backend..."
          try {
              $backendResult = Invoke-RestMethod -Uri "http://localhost:3001/api/hello" -TimeoutSec 5
              Write-Host "âœ… Backend API: $($backendResult.message)"
          } catch {
              Write-Host "âŒ Backend API failed"
          }

          # ØªØ³Øª Frontend
          Write-Host "Testing Frontend..."
          try {
              $frontendResult = Invoke-WebRequest -Uri "http://localhost:8080" -UseBasicParsing -TimeoutSec 5
              Write-Host "âœ… Frontend: HTTP $($frontendResult.StatusCode)"
          } catch {
              Write-Host "âŒ Frontend failed"
          }
