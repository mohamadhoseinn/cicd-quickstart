name: CI/CD with Caddy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # دریافت کد
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1. توقف سرویس‌های قبلی
      - name: Stop old services
        run: |
          taskkill /F /IM node.exe /T 2>nul || echo "No node processes"
          taskkill /F /IM caddy.exe /T 2>nul || echo "No caddy processes"
          timeout /t 3 /nobreak

      # 2. دانلود Caddy (اگر نیاز است)
      - name: Setup Caddy
        run: |
          if (-Not (Test-Path "caddy\caddy.exe")) {
            echo "Downloading Caddy..."
            Invoke-WebRequest "https://github.com/caddyserver/caddy/releases/download/v2.7.6/caddy_2.7.6_windows_amd64.zip" -OutFile caddy.zip
            Expand-Archive caddy.zip -DestinationPath .\caddy_temp
            mkdir caddy -Force
            Move-Item .\caddy_temp\caddy.exe .\caddy\
            Remove-Item caddy.zip, caddy_temp -Recurse -Force
          }

      # 3. اجرای Backend
      - name: Start Backend
        run: |
          cd backend
          npm install

          # اجرای backend در پس‌زمینه
          $backend = Start-Process node -ArgumentList "server.js" -PassThru -WindowStyle Hidden
          $backend.Id | Out-File "..\backend_pid.txt"

          # منتظر بمان
          timeout /t 5 /nobreak

          # تست backend
          curl http://localhost:3001/api/hello || echo "Backend test failed"

      # 4. Build Frontend
      - name: Build Frontend
        run: |
          cd frontend
          npm install
          npm run build

          # کپی به پوشه Caddy
          mkdir ..\caddy\www -Force
          Copy-Item dist\* ..\caddy\www -Recurse -Force

      # 5. اجرای Caddy
      - name: Start Caddy
        run: |
          cd caddy

          # مطمئن شو Caddyfile وجود دارد
          if (-Not (Test-Path "Caddyfile")) {
            @'
            :8080 {
                root * ./www
                file_server
                try_files {path} /index.html
                
                handle /api/* {
                    reverse_proxy localhost:3001
                }
            }
            '@ | Out-File Caddyfile -Encoding UTF8
          }

          # اجرای Caddy
          Start-Process ".\caddy.exe" -ArgumentList "run --config Caddyfile" -WindowStyle Hidden

          # منتظر بمان
          timeout /t 5 /nobreak

          # تست Caddy
          curl http://localhost:8080 || echo "Caddy test failed"

      # 6. نمایش وضعیت
      - name: Show Status
        run: |
          echo "=== Checking Services ==="
          echo "Backend PID:"; Get-Content backend_pid.txt -ErrorAction SilentlyContinue
          echo ""
          echo "=== Ports ==="
          netstat -ano | findstr ":8080 :3001" || echo "Ports not found"
          echo ""
          echo "=== Processes ==="
          tasklist | findstr "node.exe caddy.exe" || echo "Processes not found"
